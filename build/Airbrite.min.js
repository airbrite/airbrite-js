/*! Airbrite 2013-10-25 */
_.extend(_,{flattenObject:function(a){var b={},c=".";_.isArray(a)&&(b=[]);for(var d in a){_.isNaN(Number(d))||(d=Number(d));var e=a[d];if(!_.isEmpty(e)&&_.isArray(e)){var f=_.flattenObject(e);b[d]=f}else if(_.isEmpty(e)||_.get(e,"constructor")!==Object)b[d]=e;else{var f=_.flattenObject(e);for(var g in f){var h=f[g];b[d+c+g]=h}}}return b},get:function(a,b,c){if(_.isEmpty(a)||_.isEmpty(b))return c;_.isString(b)||(b=b.toString()),b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");for(var d,e=b.split(".");e.length>0;){if(d=e.shift(),!_.has(a,d))return c;a=a[d]}return a},set:function(a,b,c){_.isUndefined(a)&&(a={}),_.isString(b)||(b=b.toString()),b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");var d,e,f=b.split(".");for(e=a;f.length>0;)if(d=f.shift(),_.isNaN(Number(d))||(d=Number(d)),0===f.length)e[d]=c;else if(e[d]&&_.isObject(e[d]))e=e[d];else{if(e[d]&&_.isObject(e[d]))break;e[d]=_.isNaN(Number(d))?{}:[],e=e[d]}}}),_.extend(Backbone.Model.prototype,{get:function(a,b){return _.get(this.attributes,a,b)},set:function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a)return this;if("object"==typeof a?(e=a,c=b):_.set(e={},a,b),c||(c={}),!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],i=this._changing,this._changing=!0,i||(this._previousAttributes=_.clone(this.attributes),this.changed={}),k=this.attributes,j=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]),e=_.flattenObject(e);for(d in e)b=e[d],_.isEqual(k[d],b)||g.push(d),_.isEqual(j[d],b)?delete this.changed[d]:this.changed[d]=b,f?delete k[d]:_.set(k,d,b);if(!h){g.length&&(this._pending=!0);for(var l=0,m=g.length;m>l;l++)this.trigger("change:"+g[l],this,k[g[l]],c)}if(i)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this}}),Airbrite=function(){var a,b={},c="https://api.airbrite.io/v2";return b._syncWithKey=function(b,c,d){d.beforeSend=function(b){b.withCredentials=!0,b.setRequestHeader("Authorization",a)},Backbone.sync.call(this,b,c,d)},b.setPublishableKey=function(b){a=b},b.getPublishableKey=function(){return a},b.setPaymentToken=function(a){if(!("stripe"in a))throw new Error("Please provide a supported gateway configuration. Currently supported payment gateways: stripe");Stripe.setPublishableKey(a.stripe.publishableKey)},b._getBaseUrl=function(){return c},b}(),Airbrite=function(a){return a.Product=Backbone.Model.extend({idAttribute:"_id",urlRoot:a._getBaseUrl()+"/products",sync:a._syncWithKey}),a.Products=Backbone.Collection.extend({model:a.Product,url:a._getBaseUrl()+"/products",sync:a._syncWithKey,parse:function(a){return a.data}}),a}(Airbrite),Airbrite=function(a){function b(){var a=this.changedAttributes();a&&"updated"in a}return a.Order=Backbone.Model.extend({idAttribute:"_id",sync:a._syncWithKey,urlRoot:a._getBaseUrl()+"/orders",parse:function(a){return a.data},defaults:{line_items:[],payments:[]},getItemProducts:function(){return this.get("line_items").map(function(a){var b=new Airbrite.Product({sku:a.sku});return b.fetch(),b})},addItem:function(a,b){var c;"object"==typeof a?(c=a.sku||a.get&&a.get("sku"),b=b||a.quantity):c=a,b=b||1;var d=this.get("line_items"),e=_.findWhere(d,{sku:c});e||(e={sku:c,quantity:0},d.push(e)),e.quantity+=b,this.trigger("change")},removeItem:function(){var a;a="object"==typeof sku_or_params?sku_or_params.sku||sku_or_params.get&&sku_or_params.get("sku"):sku_or_params;var b=this.get("line_items"),c=_.find(b,function(b){return b.sku==a});return c?(this.set({line_items:_.without(b,c)}),!0):void 0},getItemsSubtotal:function(){var a=this.get("line_items").reduce(function(a,b){return a+b.price*b.quantity},0);return a/100},addPayment:function(a){var b=this.get("payments"),c={gateway:"stripe",amount:a.amount,currency:a.currency};b.push(c);var d=this;Stripe.createToken(a,function(a,b){b.error?console.log("error tokenizing card: "+b.error.message):(c.card_token=b.id,d.trigger("change"),d.trigger("complete"))})},constructor:function(){this.on("change",b,this),Backbone.Model.apply(this,arguments)}}),a}(Airbrite);