/*! Airbrite 2013-11-18 */
window.Airbrite=function(a){var b,c="https://api.airbrite.io/v2";return _paymentGateway=void 0,a._getPaymentGateway=function(){return _paymentGateway},a._syncWithKey=function(a,c,d){d.beforeSend=function(a){a.withCredentials=!0,a.setRequestHeader("Authorization",b)},Backbone.sync.call(this,a,c,d)},a.setPublishableKey=function(a){b=a},a.getPublishableKey=function(){return b},a.setPaymentToken=function(a){if(!("stripe"in a))throw new Error("Please provide a supported gateway configuration. Currently supported payment gateways: stripe");_loadLibrary({moduleVar:"Stripe",versionTestFunc:function(a){return 2==a.version},moduleUrl:"https://js.stripe.com/v2/",callback:function(){_paymentGateway="stripe",Stripe.setPublishableKey(a.stripe.publishableKey)}})},a._getBaseUrl=function(){return c},a._checkParams=function(a,b,c){c=c||function(a){throw Error("Missing parameters: "+a.join(", "))},b=b||{},"object"!=typeof b&&(b={});var d=[];a.forEach(function(a){a in b||d.push(a)}),d.length>0&&c(d)},_loadLibrary=function(a){if(!window.console||!window.console.log){var b={};b.log=function(){}}if(void 0!==window[a.moduleVar]&&a.versionTestFunc(window[a.moduleVar]))a.callback();else{var c=document.createElement("script");c.setAttribute("type","text/javascript"),c.setAttribute("src",a.moduleUrl),c.readyState?c.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&a.callback()}:c.onload=a.callback,(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(c)}},a}(window.Airbrite||{}),_.extend(_,{flattenObject:function(a){var b={},c=".";_.isArray(a)&&(b=[]);for(var d in a){_.isNaN(Number(d))||(d=Number(d));var e,f=a[d];if(!_.isEmpty(f)&&_.isArray(f))e=_.flattenObject(f),b[d]=e;else if(_.isEmpty(f)||_.get(f,"constructor")!==Object)b[d]=f;else{e=_.flattenObject(f);for(var g in e){var h=e[g];b[d+c+g]=h}}}return b},get:function(a,b,c){if(_.isEmpty(a)||_.isEmpty(b))return c;_.isString(b)||(b=b.toString()),b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");for(var d,e=b.split(".");e.length>0;){if(d=e.shift(),!_.has(a,d))return c;a=a[d]}return a},set:function(a,b,c){_.isUndefined(a)&&(a={}),_.isString(b)||(b=b.toString()),b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");var d,e,f=b.split(".");for(e=a;f.length>0;)if(d=f.shift(),_.isNaN(Number(d))||(d=Number(d)),0===f.length)e[d]=c;else if(e[d]&&_.isObject(e[d]))e=e[d];else{if(e[d]&&_.isObject(e[d]))break;e[d]=_.isNaN(Number(d))?{}:[],e=e[d]}}}),_.extend(Backbone.Model.prototype,{get:function(a,b){return _.get(this.attributes,a,b)},set:function(a,b,c){var d,e,f,g,h,i,j,k;if(null===a||void 0===a)return this;if("object"==typeof a?(e=a,c=b):_.set(e={},a,b),c=c||{},!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],i=this._changing,this._changing=!0,i||(this._previousAttributes=_.clone(this.attributes),this.changed={}),k=this.attributes,j=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]),e=_.flattenObject(e);for(d in e)b=e[d],_.isEqual(k[d],b)||g.push(d),_.isEqual(j[d],b)?delete this.changed[d]:this.changed[d]=b,f?delete k[d]:_.set(k,d,b);if(!h){g.length&&(this._pending=!0);for(var l=0,m=g.length;m>l;l++)this.trigger("change:"+g[l],this,k[g[l]],c)}if(i)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this}}),window.Airbrite=function(a){return a.Order=Backbone.Model.extend({idAttribute:"_id",sync:a._syncWithKey,urlRoot:a._getBaseUrl()+"/orders",parse:function(a){return a.data},defaults:{line_items:[],payments:[]},validate:function(a){return a.line_items&&a.line_items.length?void 0:"Order has no items. Use 'addItem' function to add items to your order"},addItem:function(b,c){var d;"object"==typeof b?(a._checkParams(["sku","quantity"],b),d=b.sku||b.get&&b.get("sku"),c=c||b.quantity):d=b,c=c||1;var e=this.get("line_items"),f=_.findWhere(e,{sku:d});f||(f={sku:d,quantity:0},e.push(f)),f.quantity+=c,this.trigger("change")},removeItem:function(a){var b;b="object"==typeof a?a.sku||a.get&&a.get("sku"):a;var c=this.get("line_items"),d=_.find(c,function(a){return a.sku==b});return d?(this.set({line_items:_.without(c,d)}),!0):void 0},getItems:function(){return this.get("line_items")},addPayment:function(b,c){b=b||{},a._checkParams(["number","exp_month","exp_year","amount","currency","cvc"],b);var d=this.get("payments"),e={amount:b.amount,currency:b.currency};d.push(e);var f=this;if("stripe"==a._getPaymentGateway())Stripe.createToken(b,function(d,g){if(g.error){var h="Error tokenizing card: "+g.error.message;f.trigger("error",f,h,b),$.isFunction(c)&&c("error",h)}else e.card_token=g.id,e.gateway=a._getPaymentGateway(),f.trigger("change"),f.trigger("tokenized"),$.isFunction(c)&&c("success")});else{var g="No payment gateway configured. Use: Airbrite.setPaymentToken()";$.isFunction(c)&&(f.trigger("error",f,g),c("error",g))}},setCustomer:function(a){this.set("customer",a)},setShippingAddress:function(a){this.set("shipping_address",a)},submit:function(a){var b={};return $.isFunction(a)&&(b.success=function(){a("success")},b.error=function(b,c){var d="Error submitting order";if("string"==typeof c&&(d+=": "+c),"object"==typeof c)try{var e=JSON.parse(c.responseText);d+=": "+e.meta.error_message}catch(f){d+=": "+c.responseText}a("error",d)}),this.save({},b)},save:function(){var a=arguments;return 0===a.length&&(a=[{}]),Backbone.Model.prototype.save.apply(this,a)}}),a}(window.Airbrite||{}),window.Airbrite=function(a){return a.Product=Backbone.Model.extend({idAttribute:"_id",urlRoot:a._getBaseUrl()+"/products",sync:a._syncWithKey}),a.Products=Backbone.Collection.extend({model:a.Product,url:a._getBaseUrl()+"/products",sync:a._syncWithKey,parse:function(a){return a.data}}),a}(window.Airbrite||{});